## 集群管理

[返回首页](../../)

[返回目录](./README.md)

### **功能介绍**  
集群信息的增删该查，以及集群的启动、停止、升级/部署。

### **接口介绍**  
配置管理功能有6个接口  
创建/修改集群接口  
删除集群接口  
查询集群列表接口  
执行集群接口  
查看日志接口  
执行结果信号接口

## 创建/修改集群接口

`英文名：`

createCluster

`解释：`

创建或更新集群信息，前端每次都会把集群的所有信息以一个大json传过来。
后端将json数据进行更新插入到存储里。

`接口类型：`

```
POST
/api/v1/createCluster
Content-Type:application/json
```

`请求body`

```json
{
  "name": "my cluster 1",
  "status": 1,
  "hosts": [
    {
      "id": 289
    },
    {
      "id": 28
    }
  ],
  "base": {
    "version": "1.2.0",
    "deployUser": "easy",
    "deployPath": "/home/easy"
  },
  "roles": [
    {
      "roleName": "backend",
      "dependHostId": 12,
      "backendPort": 12345
    },
    {
      "roleName": "frontend",
      "dependHostId": 12,
      "frontendPort": 8888
    },
    {
      "roleName": "database",
      "dependHostId": 12,
      "databaseType": "mysql",
      "dbName": "easy",
      "account": "easy",
      "password": "easy"
    },
    {
      "roleName": "master",
      "dependHostId": 12,
      "masterMem": 1
    },
    {
      "roleName": "worker",
      "dependHostId": 12,
      "workerMem": 1
    },
    {
      // TODO 其他角色后面再写
    }
  ]
}
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
// TODO 字段解释太多后面再写

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "更新插入失败！｛错误信息｝",
  "result": null
}
```

`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

## 删除集群接口

`英文名：`

deleteCluster

`解释：`

根据集群id，删除集群

`接口类型：`

```
POST
/api/v1/deleteCluster
Content-Type:application/json
```

`请求body`

```json
{
  "id": 19827
}
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
id|int|true||集群id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "删除失败！｛错误信息｝",
  "result": null
}
```

`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

## 查询集群列表接口

`英文名：`

selectClusterList

`解释：`

查询集群列表，会返回全部集群的数据。
供集群管理页面左侧切换使用，这里前端的压力可能稍微大一点，后期迭代成（先返回列表，用户点了列表里的id，再用id去获取具体的数据）。

`接口类型：`

```
GET
/api/v1/selectClusterList
Content-Type:application/json
```

`请求body`

```
http://0.0.0.0:15523/api/v1/selectClusterList
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": [
    {
      "id": 1,
      "name": "my cluster 1",
      "status": 1,
      "hosts": [
        {
          "id": 289
        },
        {
          "id": 28
        }
      ],
      "base": {
        "version": "1.2.0",
        "deployUser": "easy",
        "deployPath": "/home/easy"
      },
      "roles": [
        {
          "roleName": "backend",
          "dependHostId": 12,
          "backendPort": 12345
        },
        {
          "roleName": "frontend",
          "dependHostId": 12,
          "frontendPort": 8888
        },
        {
          "roleName": "database",
          "dependHostId": 12,
          "databaseType": "mysql",
          "dbName": "easy",
          "account": "easy",
          "password": "easy"
        },
        {
          "roleName": "master",
          "dependHostId": 12,
          "masterMem": 1
        },
        {
          "roleName": "worker",
          "dependHostId": 12,
          "workerMem": 1
        },
        {}
      ]
    },
    {
      "id": 2,
      "name": "my cluster 2",
      "status": 0,
      "hosts": [
        {
          "id": 289
        },
        {
          "id": 28
        }
      ],
      "base": {
        "version": "1.2.0",
        "deployUser": "easy",
        "deployPath": "/home/easy"
      },
      "roles": [
        {
          "roleName": "backend",
          "dependHostId": 12,
          "backendPort": 12345
        },
        {
          "roleName": "frontend",
          "dependHostId": 12,
          "frontendPort": 8888
        },
        {
          "roleName": "database",
          "dependHostId": 12,
          "databaseType": "mysql",
          "dbName": "easy",
          "account": "easy",
          "password": "easy"
        },
        {
          "roleName": "master",
          "dependHostId": 12,
          "masterMem": 1
        },
        {
          "roleName": "worker",
          "dependHostId": 12,
          "workerMem": 1
        },
        {}
      ]
    }
  ]
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "查询失败！｛错误内容｝",
  "result": null
}
```

`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
// TODO 后面再写

## 启动/停止集群接口

`英文名：`

executeCluster

`解释：`

执行集群相关操作，启动集群，停止集群，部署/升级集群。
执行后是马上返回【成功开始执行】的响应，判断是否【执行成功】请调用【执行结果信号接口】接口获得结果信号。
设计是成功开始执行后，前端准备个定时器每隔5秒调用【执行结果信号接口】来获得执行结果，此时其他操作均不能操作。
同一时间只能进行一个动作。

`接口类型：`

```
POST
/api/v1/executeCluster
Content-Type:application/json
```

`请求body`

```json
{
  "executeType": "start",
  "clusterId": 127
}
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
executeType|string|true||执行类型
clusterId|int|true||集群id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```
无
```

`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

## 查看日志接口

`英文名：`

readLog

`解释：`

分页查看【上一次】执行的日志，上一次的执行有多种类型，有可能是启动集群、停止集群、安装升级集群等。
这里的设计是只能查看上一次的操作日志，如果想以资源目录的形式查看，请到服务器中用命令行查看。或者下个迭代再考虑。

`接口类型：`

```
GET
/api/v1/readLog
```

`请求body`

```
http://0.0.0.0:15523/api/v1/readLog?page=1
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
page|int|true||分页数

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "currentPage": 2,
    "rows": 12592,
    "data": [
      "2020-02-10 16:21:16,124 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,128 p=7999 u=easy |  TASK [check_config_static : ensure api host exists] ****************************",
      "2020-02-10 16:21:16,140 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,145 p=7999 u=easy |  TASK [check_config_static : ensure nginx host exists] **************************",
      "2020-02-10 16:21:16,156 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,160 p=7999 u=easy |  TASK [check_config_static : check ansible_user variable] ***********************",
      "2020-02-10 16:21:16,171 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,175 p=7999 u=easy |  TASK [check_config_static : check ansible version] *****************************",
      "2020-02-10 16:21:16,187 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,191 p=7999 u=easy |  TASK [check_config_static : check if jmespath installed] ***********************"
    ]
  }
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "查看日志失败！｛错误内容｝",
  "result": null
}
```

`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
currentPage|int|||当前页数
rows|int|||总行数
data|string|||日志内容

## 执行结果信号接口

`英文名：`

executeResultSignal

`解释：`

获得执行结果信号，接口只返回【成功】或【失败】，具体原因请查看日志。

`接口类型：`

```
GET
/api/v1/executeResultSignal
```

`请求body`

```
http://0.0.0.0:15523/api/v1/executeResultSignal?id=118
```

`请求字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
id|int|true||执行id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": "success"
}
```

```json
{
  "code": 200,
  "message": "ok",
  "result": "failed"
}
```


`响应字段解释`

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||